<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Cadence_ERC20 | 0xOne1eaF's Blog Post</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"é”®å…¥ä»¥ç»§ç»­","blurHolder":"æ•°æ®æ£€ç´¢","noResult":"æ—  $0 ç›¸å…³æ•°æ®"},"code":{"codeInfo":"$0 - $1 è¡Œ","copy":"å¤åˆ¶"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: 'ç¡®è®¤'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="æ•°æ®æ£€ç´¢" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Cadence_ERC20</h1><div id="post-info"><span>æ–‡ç« å‘å¸ƒæ—¶é—´: <div class="control"><time datetime="2025-04-01T16:00:00.000Z" id="date"> 2025-04-02</time></div></span><br><span>æœ€åæ›´æ–°æ—¶é—´: <div class="control"><time datetime="2025-04-05T02:49:02.660Z" id="updated"> 2025-04-05</time></div></span></div></div><hr><div id="post-content"><h1 id="ç”¨-Cadence-å®ç°-ERC20-çš„-approve-æœºåˆ¶"><a href="#ç”¨-Cadence-å®ç°-ERC20-çš„-approve-æœºåˆ¶" class="headerlink" title="ç”¨ Cadence å®ç° ERC20 çš„ approve æœºåˆ¶"></a>ç”¨ Cadence å®ç° ERC20 çš„ approve æœºåˆ¶</h1><p>åœ¨ ERC20 ä»£å¸æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº†è¿™ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">interface IERC20 &#123;</span><br><span class="line">    // ...</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 value) external returns (bool);</span><br><span class="line"></span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint256);</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 value) external returns (bool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ <code>approve</code> æŸä¸ªåœ°å€ <code>owner</code> å¯ä»¥æˆæƒå…¶ä»–åœ°å€ <code>spender</code> èŠ±è´¹è‡ªå·±ä¸€å®šé‡‘é¢çš„ä»£å¸</li>
<li>é€šè¿‡ <code>allowance</code> æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ <code>owner</code> ç»™ <code>spender</code> çš„æˆä¿¡é¢åº¦ä½™é¢</li>
<li>é€šè¿‡ <code>transferFrom</code> ï¼Œ<code>spender</code> å¯ä»¥ä» <code>owner</code> å†…å–ç”¨æˆä¿¡é¢åº¦å†…çš„é‡‘é¢</li>
</ul>
<p>è¿™å‡ ä¸ªæ–¹æ³•åœ¨ ERC20 çš„ä¸–ç•Œä¸­æ˜¯å¿…é¡»çš„ï¼Œå°¤å…¶åœ¨ä½¿ç”¨å„ç§ DeFi äº§å“çš„æ—¶å€™ã€‚ä»¥ Uniswap ä¸ºä¾‹ï¼ŒAlice å¦‚æœå¸Œæœ›æŠŠè‡ªå·±çš„ USDC æ¢æˆ AAVEï¼Œåˆ™æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·ï¼š</p>
<blockquote>
<p>Alice å¯¹ Uniswapï¼šå° U å•Šï¼Œæˆ‘å…è®¸ä½ åŠ¨æˆ‘çš„ USDCï¼Œç»™ä½  1000 USDC çš„é¢åº¦å§ã€‚ Alice å¯¹ Uniswapï¼šå° U å•Šï¼Œæˆ‘æƒ³è¦æŠŠ 1000 USDC æ¢æˆ AAVEï¼Œç»™æˆ‘æå®šï¼</p>
<p>Uniswap å¯¹ USDC åˆçº¦ï¼šæˆ‘ä»£è¡¨ Alice ä»å¥¹è´¦ä¸Šè½¬ 1000 USDC åˆ° AAVE-USDC æµåŠ¨æ€§æ± çš„è´¦ä¸Šï¼ ï¼ˆå‡è®¾ç®—å‡ºæ¥ Alice èƒ½æ¢åˆ° 5 ä¸ª AAVEï¼‰ Uniswap å¯¹ AAVE åˆçº¦ï¼šæŠŠè¿™ 5 ä¸ª AAVE ä»æˆ‘æ± å­è´¦ä¸Šè½¬åˆ° Alice è´¦ä¸Šï¼</p>
</blockquote>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>ERC20 æ ‡å‡†ä¸‹ï¼Œæ‰€æœ‰ä»£å¸éƒ½æ˜¯ç”±å…¶åˆçº¦åšç»Ÿä¸€è®°è´¦çš„ã€‚æ¯”å¦‚ Uniswap ä» Alice è´¦æˆ·å‘æµåŠ¨æ€§æ± è½¬è´¦ USDC çš„æ“ä½œï¼Œå®é™…ä¸Šå°±æ˜¯ç”± USDC åˆçº¦åšä¸€ä¸‹è´¦ç›®å˜æ›´ã€‚ä»£å¸åˆçº¦å¯ä»¥ç±»æ¯”ä¸ºç°å®ä¸–ç•Œä¸­çš„é“¶è¡Œï¼Œæ¯ä¸ªå‚¨æˆ·çš„èµ„é‡‘åªæ˜¯ä»–ä»¬è´¦ä¸Šçš„æ•°å­—ã€‚</li>
<li>EVM ç”Ÿæ€ä¸­å’Œåˆçº¦çš„äº¤äº’æœ‰ç‚¹åƒå¯¹è‡ªå·±çš„åŠ©ç†è¯´è¯ï¼Œç»™ä»–æˆæƒï¼Œå…·ä½“çš„æ‰§è¡Œç”±ä»–è´Ÿè´£ã€‚æ¯ç¬”äº¤æ˜“çš„å†…å®¹åŸºæœ¬ä¸Šå°±æ˜¯å¯¹åˆçº¦ä¸­ç‰¹å®šæ–¹æ³•çš„è°ƒç”¨ã€‚æ‰§è¡Œæ“ä½œçš„ä¸»è¦é€»è¾‘éƒ½åœ¨åˆçº¦é‡Œã€‚</li>
</ul>
<p>åœ¨è¿™æ ·çš„æœºåˆ¶ä¸‹ï¼Œapprove æœºåˆ¶å°±æ˜¾å¾—æ ¼å¤–é‡è¦ã€‚æ²¡æœ‰æˆæƒï¼Œåˆ™æ¥ä¸‹æ¥çš„æ‰§è¡Œæ— ä»è°ˆèµ·ã€‚</p>
<p>åœ¨ä»¥å¯¹èµ„æºçš„å¤„ç†ä¸ºç‰¹è‰²çš„ Cadence ä¸–ç•Œä¸­ï¼Œæƒ…å†µå°±ä¸ä¸€æ ·äº†ã€‚ä»¥ BloctoSwap ä¸ºä¾‹ï¼ŒAlice å¦‚æœå¸Œæœ›æŠŠè‡ªå·±çš„ 1000 FUSD æ¢æˆ BLTï¼Œåˆ™ï¼š</p>
<blockquote>
<p>Alice ä»è‡ªå·±çš„å‚¨è—å®¤é‡Œé¢æ‹¿å‡º FUSD ä¿é™©ç®±ï¼Œä»ä¸­å–å‡º 1000 ä¸ª FUSD Alice æŠŠ 1000 ä¸ª FUSD é€è¿› BloctoSwapï¼ŒBloctoSwap æ”¶åˆ°åç»™å¥¹é€å› 2000 ä¸ª BLT</p>
<p>Alice æŠŠ 2000 ä¸ª BLT æ”¾è¿›è‡ªå·±çš„ BLT ä¿é™©ç®±ï¼Œå†æŠŠä¿é™©ç®±æ”¾è¿›å‚¨è—å®¤é‡Œ</p>
</blockquote>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>åœ¨ Flow ç”Ÿæ€ä¸­ï¼Œä»£å¸æ˜¯ç”±è´¦æˆ·ç›´æ¥æŒæœ‰çš„ï¼Œè€Œéç”±ä»£å¸åˆçº¦è®°è´¦è¡¨ç¤ºã€‚ç›¸è¾ƒäº EVM ç”Ÿæ€ï¼Œè¿™ç§æ¨¡å¼æ˜¯æ›´å»ä¸­å¿ƒåŒ–çš„ã€‚</li>
<li>Flow ç”Ÿæ€ä¸­å’Œåˆçº¦çš„äº¤äº’æ›´åƒæ˜¯ä»å·¥å…·ç®±ä¸­å–å·¥å…·ï¼Œå…·ä½“äº‹åŠ¡çš„æ‰§è¡Œè¿˜éœ€è¦è´¦æˆ·åœ¨äº¤æ˜“ä¸­äº²åŠ›äº²ä¸ºã€‚Flow çš„äº¤æ˜“ä¸æ˜¯å•çº¯çš„æ–¹æ³•è°ƒç”¨ï¼Œè¿˜æœ‰è®¸å¤šæ‰§è¡Œé€»è¾‘ã€‚</li>
</ul>
<p>ä¸¤ç›¸å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ Flow ç”Ÿæ€å¯¹ approve æœºåˆ¶å¹¶æ²¡æœ‰åƒ EVM ç”Ÿæ€é‚£æ ·çš„åˆšéœ€ï¼Œä½†å¦‚æœæˆ‘ä»¬å°±æ˜¯è¦ç”¨ Cadence æ¥å®ç° approve åŠŸèƒ½ï¼Œè®©åˆ«äººå¯ä»¥åŠ¨ç”¨è‡ªå·±çš„éƒ¨åˆ†èµ„é‡‘ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæˆ‘ä»¬å›é¡¾ğŸ‘†æåˆ°çš„ Flow å’Œ EVM ç³»çš„åŒºåˆ«ï¼š</p>
<ul>
<li>EVM çš„ä»£å¸åªæ˜¯åˆçº¦ä¸­è®°å½•çš„æ•°å­—ï¼Œç”±ä¸€ä¸ªä¸­å¿ƒè´¦æœ¬ç®¡ç†ã€‚å®ç° <code>approve</code> åªéœ€è¦åœ¨è´¦æœ¬ä¸­è®°å½•ä¸‹ <code>spender</code> ã€<code>owner</code> å’Œæˆä¿¡é‡‘é¢ï¼Œè½¬è´¦çš„æ—¶å€™æ®æ­¤éªŒè¯ã€è°ƒè´¦å³å¯ã€‚</li>
<li>Flow çš„ä»£å¸æ˜¯åˆ†æ•£å­˜å‚¨åœ¨ä¸åŒè´¦æˆ·ä¸­çš„ã€‚è¦å®ç° <code>approve</code> åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦è®© <code>spender</code> èƒ½å¤Ÿç¡®å®åœ°è®¿é—®åˆ° <code>owner</code> è´¦æˆ·ä¸­çš„â€œä¿é™©ç®±â€ï¼Œè€Œéåœ¨æŸä¸ªè´¦æœ¬ä¸Šè°ƒè´¦ã€‚</li>
</ul>
<p>è¿™ç‚¹å·®å¼‚ä½¿å¾—åœ¨ Flow ä¸Šå®ç° ERC20 æ ‡å‡†ä¸­çš„ approve æœºåˆ¶ä¼šæ›´å¤æ‚ã€‚</p>
<p>Flow æ˜¯ Capability-based Access Controlï¼Œå¯ä»¥ç†è§£æˆâ€œè®¤è¯ä¸è®¤äººâ€ï¼ŒæŒæœ‰ç‰¹å®šâ€œä»¤ç‰Œâ€å°±èƒ½åšç‰¹å®šçš„äº‹ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªèƒ½è®© <code>spender</code> è®¿é—®å¹¶<strong>æœ‰é™åˆ¶</strong>åœ°ä½¿ç”¨ <code>owner</code> â€ä¿é™©ç®±â€œçš„â€ä»¤ç‰Œâ€œã€‚å†å…·ä½“æ•´ç†ä¸‹ï¼Œå°±æœ‰ä»¥ä¸‹éœ€æ±‚ï¼š</p>
<ol>
<li><code>owner</code> å¯ä»¥æˆæƒç»™å¤šä¸ª <code>spender</code> è®¿é—®è‡ªå·±çš„èµ„é‡‘ã€‚</li>
<li><code>spender</code> å¯¹èµ„é‡‘çš„è®¿é—®æ˜¯å—é™äºæˆä¿¡é¢åº¦çš„ï¼Œæ¯ä¸ª <code>spender</code> å¯ä»¥æœ‰ä¸åŒçš„æˆä¿¡é¢åº¦ã€‚</li>
<li>æˆä¿¡é¢åº¦å¯ä»¥è¶…è¿‡ <code>owner</code> ç°æœ‰èµ„é‡‘æ€»é‡ã€‚æ¯”å¦‚ Alice æ‹¥æœ‰ 40 FUSDï¼Œä»–å¯ä»¥æˆæƒ Bob å’Œ Carl æœ€å¤šåŠ¨ç”¨ 30 FUSDï¼ŒDave æœ€å¤šåŠ¨ç”¨ 50 FUSDã€‚</li>
<li><code>owner</code> å¯ä»¥éšæ—¶è°ƒæ•´ <code>spender</code> çš„æˆä¿¡é¢åº¦ï¼Œæˆ–è€…å–æ¶ˆã€æ¢å¤æˆä¿¡ã€‚</li>
</ol>
<p>åœ¨ Flow ä¸­ï¼Œ<code>Capability</code> å°±æ˜¯æ‰€è°“çš„â€œä»¤ç‰Œâ€œã€‚å‡è®¾å·²ç»æœ‰äº†ä¸€ä¸ªéµå¾ªå®˜æ–¹ FT æ¥å£çš„ä»£å¸ FUSDï¼Œåœ¨æˆ‘ä»¬çš„ <code>/storage/fusdVault</code> è·¯å¾„ä¸­å­˜æ”¾ç€ <code>@FUSD.Vault</code> ï¼Œå¦‚æœæˆ‘ä»¬æ˜¯è¿™ä¸ª Vault çš„æŒæœ‰äºº Aliceï¼Œç°åœ¨æƒ³è®© Bob ä¹Ÿèƒ½å¤Ÿä½¿ç”¨å®ƒï¼Œä¸€ä¸ªæ–¹æ³•å°±æ˜¯å°†å…¶ link åˆ° <code>/private</code> ä¸­ï¼Œç”Ÿæˆç§æœ‰çš„ <code>Capability&lt;&amp;FUSD.Vault&gt;</code>ï¼Œå†å°†è¿™ä¸ª <code>Capability</code> äº¤ç»™ Bobã€‚è¿™æ ·ä¸€æ¥ï¼ŒBob å°±å¯ä»¥é€šè¿‡ <code>Capability</code> è®¿é—®åˆ°æˆ‘ä»¬çš„ <code>@FUSD.Vault</code>ã€‚</p>
<p>è¿™æ ·åšçš„é—®é¢˜åœ¨äºï¼šBob å¯¹äº Vault çš„è®¿é—®æ˜¯æ— é™åˆ¶çš„ã€‚å¦‚æœä»–æƒ³ï¼Œä»–å¯ä»¥è½¬èµ°æ•´ä¸ª Vault ä¸­çš„èµ„é‡‘ã€‚è¿™æ ·ä¸ç¬¦åˆéœ€æ±‚ 2ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æŠŠ Vault å¯¹æ¯ä¸ª <code>spender</code> æ‹†åˆ†å‡ºç­‰åŒäºæˆä¿¡é¢åº¦çš„ä¸€ä»½ï¼Œåˆ™ä¸æ»¡è¶³éœ€æ±‚ 3ã€‚</p>
<p>æˆ‘ä»¬é‡ç‚¹è§£å†³å¯¹ Vault è®¿é—®æ— é™åˆ¶çš„é—®é¢˜ã€‚ç°åœ¨æˆ‘ä»¬åœ¨ Vault å¤–å†åŒ…ä¸€å±‚ï¼Œç”¨äºæ·»åŠ é¢åº¦é™åˆ¶ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pub resource <span class="type">Allowance</span>: <span class="type">AllowanceInfo</span>, <span class="type">AllowanceProvider</span>, <span class="type">AllowanceManager</span> &#123;</span><br><span class="line">    pub <span class="keyword">var</span> value: <span class="type">UFix64</span></span><br><span class="line">    priv <span class="keyword">let</span> vaultCap: <span class="type">Capability</span>&lt;&amp;&#123;<span class="type">FungibleToken</span>.<span class="type">Provider</span>, <span class="type">FungibleToken</span>.<span class="type">Balance</span>&#125;&gt;</span><br><span class="line"></span><br><span class="line">    pub fun getVaultOwner(): <span class="type">Address</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.vaultCap.address</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pub fun setAllowance(value: <span class="type">UFix64</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pub fun withdraw(amount: <span class="type">UFix64</span>): <span class="meta">@FungibleToken</span>.<span class="type">Vault</span> &#123;</span><br><span class="line">        pre &#123;</span><br><span class="line">            amount <span class="operator">&lt;=</span> <span class="keyword">self</span>.value: <span class="string">&quot;Withdraw amount exceed allowance value&quot;</span></span><br><span class="line">            amount <span class="operator">&lt;=</span> <span class="keyword">self</span>.vaultCap.borrow()<span class="operator">!</span>.balance: <span class="string">&quot;Withdraw amount exceed vault&#x27;s balance&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> <span class="keyword">self</span>.value <span class="operator">-</span> amount</span><br><span class="line">        <span class="keyword">return</span> <span class="operator">&lt;-</span> <span class="keyword">self</span>.vaultCap.borrow()<span class="operator">!</span>.withdraw(amount: amount)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">value</span>: <span class="type">UFix64</span>, <span class="params">vaultCap</span>: <span class="type">Capability</span>&lt;&amp;&#123;<span class="type">FungibleToken</span>.<span class="type">Provider</span>, <span class="type">FungibleToken</span>.<span class="type">Balance</span>&#125;&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">self</span>.vaultCap <span class="operator">=</span> vaultCap</span><br><span class="line"></span><br><span class="line">        emit <span class="type">AllowanceCreated</span>(by: <span class="keyword">self</span>.owner<span class="operator">?</span>.address, value: value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Allowance èµ„æºçš„ vaultCap å­—æ®µå­˜å‚¨çš„æ˜¯è®¿é—®ç›®æ ‡ Vault çš„ <code>Capability</code>ï¼Œæˆ‘ä»¬å°†å…¶é™å®šä¸ºå®ç° <code>FungibleToken.Provider</code> å’Œ <code>FungibleToken.Balance</code> çš„ä»»æ„èµ„æºã€‚</p>
<p>å¦å¤–ï¼ŒAllowance è¿˜å®ç°äº† 3 ä¸ªæ¥å£ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pub resource interface <span class="type">AllowanceInfo</span> &#123;</span><br><span class="line">    pub <span class="keyword">var</span> value: <span class="type">UFix64</span></span><br><span class="line">    pub fun getVaultOwner(): <span class="type">Address</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub resource interface <span class="type">AllowanceProvider</span> &#123;</span><br><span class="line">    pub fun withdraw(amount: <span class="type">UFix64</span>): <span class="meta">@FungibleToken</span>.<span class="type">Vault</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub resource interface <span class="type">AllowanceManager</span> &#123;</span><br><span class="line">    pub fun setAllowance(value: <span class="type">UFix64</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>AllowanceInfo</code> æä¾›äº†è¿™ä¸ªæˆæƒçš„é‡‘é¢å’Œåˆ›å»ºäººä¿¡æ¯ã€‚</li>
<li><code>AllowanceProvider</code> æä¾›äº†å’Œ <code>Vault</code> ä¸€è‡´çš„ withdraw æ–¹æ³•ï¼Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ¯”è¾ƒå–æ¬¾é‡‘é¢å’Œæˆä¿¡é¢åº¦ï¼Œä¿è¯å–æ¬¾é‡‘é¢åœ¨æˆä¿¡é¢åº¦å†…ã€‚</li>
<li><code>AllowanceManager</code> æä¾›äº†ä¿®æ”¹æˆä¿¡é¢åº¦çš„æ–¹æ³•ã€‚</li>
</ul>
<p>ç°åœ¨ Alice å¯ä»¥å‘ Bob æä¾› Allowance çš„ <code>Capability</code> æ¥è®©ä»–å¯ä»¥åŠ¨ç”¨è‡ªå·±çš„èµ„é‡‘äº†ã€‚</p>
<p>å¯¹äº Bob è€Œè¨€ï¼Œä»–éœ€è¦èƒ½å¤Ÿé€šè¿‡ <code>AllowanceInfo</code> æä¾›çš„å­—æ®µæ¥è·å–å‰©ä½™é¢åº¦å’Œæˆæƒäººï¼Œéœ€è¦é€šè¿‡ <code>AllowanceProvider</code> çš„ <code>withdraw</code> æ–¹æ³•æ¥è½¬è´¦ã€‚ä½†æ˜¯ä»–ä»¬ä¸åº”è¯¥è¢«å…è®¸è°ƒç”¨ <code>setAllowance</code> æ–¹æ³•ä¿®æ”¹é™é¢ï¼Œæ‰€ä»¥æä¾›ç»™ Bob çš„åº”è¯¥æ˜¯ <code>Capability&lt;&amp;&#123;AllowanceProvider, AllowanceInfo&#125;&gt;</code>ã€‚</p>
<p>Bob å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>AllowanceCapReceiver</code> æ¥å­˜æ”¾è‡ªå·±æ¥æ”¶åˆ°çš„å„ç§æˆæƒï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pub resource <span class="type">AllowanceCapReceiver</span>: <span class="type">AllowanceCapReceiverPublic</span> &#123;</span><br><span class="line">    priv <span class="keyword">var</span> allowanceCaps: &#123;<span class="type">Address</span>: [<span class="type">Capability</span>&lt;&amp;&#123;<span class="type">AllowanceProvider</span>, <span class="type">AllowanceInfo</span>&#125;&gt;]&#125;</span><br><span class="line"></span><br><span class="line">    pub fun addAllowanceCap(<span class="keyword">_</span> cap: <span class="type">Capability</span>&lt;&amp;&#123;<span class="type">AllowanceProvider</span>, <span class="type">AllowanceInfo</span>&#125;&gt;) &#123;</span><br><span class="line">        <span class="keyword">let</span> caps: [<span class="type">Capability</span>&lt;&amp;&#123;<span class="type">AllowanceProvider</span>, <span class="type">AllowanceInfo</span>&#125;&gt;] <span class="operator">=</span> <span class="keyword">self</span>.allowanceCaps[cap.address] <span class="operator">??</span> []</span><br><span class="line">        caps.append(cap)</span><br><span class="line">        <span class="keyword">self</span>.allowanceCaps[cap.address] <span class="operator">=</span> caps</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pub fun getAllowanceCapsInfoByApprover(<span class="keyword">_</span> approver: <span class="type">Address</span>): [<span class="operator">&amp;</span>&#123;<span class="type">AllowanceInfo</span>&#125;] &#123;</span><br><span class="line">        <span class="keyword">let</span> infos: [<span class="operator">&amp;</span>&#123;<span class="type">AllowanceInfo</span>&#125;] <span class="operator">=</span> []</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> caps <span class="operator">=</span> <span class="keyword">self</span>.allowanceCaps[approver] &#123;</span><br><span class="line">            <span class="keyword">for</span> cap <span class="keyword">in</span> caps &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> info <span class="operator">=</span> cap.borrow() &#123;</span><br><span class="line">                    infos.append(info)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> infos</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pub fun getAllowanceCapsByApprover(<span class="keyword">_</span> approver: <span class="type">Address</span>): [<span class="type">Capability</span>&lt;&amp;&#123;<span class="type">AllowanceProvider</span>, <span class="type">AllowanceInfo</span>&#125;&gt;] &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.allowanceCaps[approver] <span class="operator">??</span> []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.allowanceCaps <span class="operator">=</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">        emit <span class="type">AllowanceCapReceiverCreated</span>(by: <span class="keyword">self</span>.owner<span class="operator">?</span>.address)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AllowanceReceiver å®ç°äº†ä¸‹é¢çš„æ¥å£ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pub resource interface <span class="type">AllowanceCapReceiverPublic</span> &#123;</span><br><span class="line">    pub fun addAllowanceCap(<span class="keyword">_</span> allowance: <span class="type">Capability</span>&lt;&amp;&#123;<span class="type">AllowanceProvider</span>, <span class="type">AllowanceInfo</span>&#125;&gt;)</span><br><span class="line">    pub fun getAllowanceCapsInfoByApprover(<span class="keyword">_</span> approver: <span class="type">Address</span>): [<span class="operator">&amp;</span>&#123;<span class="type">AllowanceInfo</span>&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bob åªä¼šæš´éœ² <code>AllowanceCapReceiverPublic</code> ä¸­çš„æ–¹æ³•ç»™å¤–éƒ¨ï¼Œä½¿å¾— Alice å¯ä»¥é€šè¿‡ addAllowanceCap æ–¹æ³•æ¥å¯¹ Bob è¿›è¡Œæˆæƒã€‚<code>getAllowanceCapsByApprover</code> åˆ™åªèƒ½ç”±è¢«æˆæƒæ–¹ Bob è‡ªå·±è°ƒç”¨ã€‚</p>
<p>Bob å¯èƒ½æ”¶åˆ°æ¥è‡ªå¤šä¸ªå…¶ä»–è´¦æˆ·çš„æˆæƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°ç»„æ¥å­˜æ”¾ allowancesã€‚</p>
<p>ç°åœ¨ Alice å’Œ Bob è¦ä½¿ç”¨ <code>Approver</code> åˆçº¦é‡Œé¢çš„å·¥å…·è¿›è¡Œèµ„é‡‘çš„æˆæƒï¼ŒAlice æ˜¯æˆæƒäººï¼ŒBob æ˜¯è¢«æˆæƒäººã€‚é‚£ä¹ˆï¼š</p>
<ul>
<li>Bob éœ€è¦åˆ›å»º <code>AllowanceCapReceiver</code>ï¼Œå¹¶æš´éœ² <code>AllowanceCapReceiverPublic</code> æ¥å£</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FUSD from &quot;../contracts/FUSD.cdc&quot;</span><br><span class="line"><span class="keyword">import</span> FungibleToken from &quot;../contracts/FungibleToken.cdc&quot;</span><br><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">transaction &#123;</span><br><span class="line">    prepare(signer: <span class="type">AuthAccount</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> signer.borrow<span class="operator">&lt;&amp;</span><span class="type">Approver</span>.<span class="type">AllowanceCapReceiver</span><span class="operator">&gt;</span>(from: <span class="type">Approver</span>.<span class="type">AllowanceCapReceiverStoragePath</span>) <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        signer.save(</span><br><span class="line">            <span class="operator">&lt;-</span> <span class="type">Approver</span>.createAllowanceCapReceiver(), </span><br><span class="line">            to: <span class="type">Approver</span>.<span class="type">AllowanceCapReceiverStoragePath</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        signer.link<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceCapReceiverPublic</span>&#125;<span class="operator">&gt;</span>(</span><br><span class="line">            <span class="type">Approver</span>.<span class="type">AllowanceCapReceiverPubPath</span>, </span><br><span class="line">            target: <span class="type">Approver</span>.<span class="type">AllowanceCapReceiverStoragePath</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Alice ç”Ÿæˆ Vault çš„ç§æœ‰ Capabilityï¼Œå¹¶å°†ä¹‹è£…å…¥ allowance ä¸­ï¼Œå†å°† allowance ä¹Ÿæ”¾å…¥ <code>/private</code> å†…ï¼Œç”Ÿæˆç§æœ‰çš„ <code>Capability&lt;&amp;&#123;Approver.AllowanceInfo, Approver.AllowanceProvider&#125;&gt;</code> ã€‚ä¹‹å Alice ä» Bob è´¦æˆ·ä¸­å€Ÿå‡º <code>AllowanceCapReceiver</code>ï¼Œå°†ä¸Šé¢ç”Ÿæˆçš„ Allowance çš„ Capability æ”¾è¿› Receiver ä¸­ä¾› Bob ä½¿ç”¨ï¼ˆè¿™ä¸ª Capability å¯ä»¥ä¹Ÿå¯ä»¥äº¤ç»™å…¶ä»–äººä½¿ç”¨ï¼‰</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FUSD from &quot;../contracts/FUSD.cdc&quot;</span><br><span class="line"><span class="keyword">import</span> FungibleToken from &quot;../contracts/FungibleToken.cdc&quot;</span><br><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">transaction(spender: <span class="type">Address</span>, value: <span class="type">UFix64</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> allowanceCap: <span class="type">Capability</span>&lt;&amp;&#123;<span class="type">Approver</span>.<span class="type">AllowanceProvider</span>, <span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;&gt;</span><br><span class="line"></span><br><span class="line">    prepare(signer: <span class="type">AuthAccount</span>) &#123;</span><br><span class="line">        signer.link<span class="operator">&lt;&amp;</span>&#123;<span class="type">FungibleToken</span>.<span class="type">Provider</span>, <span class="type">FungibleToken</span>.<span class="type">Balance</span>&#125;<span class="operator">&gt;</span>(<span class="regexp">/private/</span>fusdVault, target: <span class="regexp">/storage/</span>fusdVault)</span><br><span class="line">        <span class="keyword">let</span> vaultCap <span class="operator">=</span> signer.getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">FungibleToken</span>.<span class="type">Provider</span>, <span class="type">FungibleToken</span>.<span class="type">Balance</span>&#125;<span class="operator">&gt;</span>(<span class="regexp">/private/</span>fusdVault)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> allowance <span class="operator">&lt;-</span> <span class="type">Approver</span>.createAllowance(</span><br><span class="line">            value: value, </span><br><span class="line">            vaultCap: vaultCap</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> pathID <span class="operator">=</span> <span class="string">&quot;fusdAllowanceFor&quot;</span>.concat(spender.toString())</span><br><span class="line">        <span class="keyword">let</span> storagePath <span class="operator">=</span> <span class="type">StoragePath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line">        <span class="keyword">let</span> publicPath <span class="operator">=</span> <span class="type">PublicPath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line">        <span class="keyword">let</span> privatePath <span class="operator">=</span> <span class="type">PrivatePath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">        signer.save(<span class="operator">&lt;-</span> allowance, to: storagePath)</span><br><span class="line"></span><br><span class="line">        signer.link<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(publicPath, target: storagePath)</span><br><span class="line"></span><br><span class="line">        signer.link<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceProvider</span>, <span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(</span><br><span class="line">            privatePath, </span><br><span class="line">            target: storagePath</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.allowanceCap <span class="operator">=</span> signer.getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceProvider</span>, <span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(privatePath)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execute &#123;</span><br><span class="line">        <span class="keyword">let</span> receiver <span class="operator">=</span> getAccount(spender).getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceCapReceiverPublic</span>&#125;<span class="operator">&gt;</span>(</span><br><span class="line">            <span class="type">Approver</span>.<span class="type">AllowanceCapReceiverPubPath</span>).borrow()</span><br><span class="line">            <span class="operator">??</span> panic(<span class="string">&quot;Could not borrow AllowanceCapReceiver capability&quot;</span>)</span><br><span class="line"></span><br><span class="line">        receiver.addAllowanceCap(<span class="keyword">self</span>.allowanceCap)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Bob ç°åœ¨å¯ä»¥ä» <code>AllowanceCapReceiver</code> ä¸­å–å‡º Alice ç»™çš„ Capabilityï¼Œå¹¶é€šè¿‡å®ƒè½¬èµ° Alice è´¦æˆ·ä¸­çš„èµ„é‡‘äº†ã€‚è¿™å¹¶ä¸å½±å“ Alice è‡ªå·±å¯¹èµ„é‡‘çš„è‡ªç”±ä½¿ç”¨ã€‚</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FUSD from &quot;../contracts/FUSD.cdc&quot;</span><br><span class="line"><span class="keyword">import</span> FungibleToken from &quot;../contracts/FungibleToken.cdc&quot;</span><br><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">transaction(from: <span class="type">Address</span>, to: <span class="type">Address</span>, value: <span class="type">UFix64</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> capReceiver: <span class="operator">&amp;</span><span class="type">Approver</span>.<span class="type">AllowanceCapReceiver</span></span><br><span class="line"></span><br><span class="line">    prepare(signer: <span class="type">AuthAccount</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.capReceiver <span class="operator">=</span> signer.borrow<span class="operator">&lt;&amp;</span><span class="type">Approver</span>.<span class="type">AllowanceCapReceiver</span><span class="operator">&gt;</span>(from: <span class="type">Approver</span>.<span class="type">AllowanceCapReceiverStoragePath</span>)</span><br><span class="line">            <span class="operator">??</span> panic(<span class="string">&quot;Could not borrow AllowanceCapReceiver reference&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execute &#123;</span><br><span class="line">        <span class="keyword">let</span> vaultReceiver <span class="operator">=</span> getAccount(to).getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">FungibleToken</span>.<span class="type">Receiver</span>&#125;<span class="operator">&gt;</span>(<span class="regexp">/public/</span>fusdReceiver).borrow()</span><br><span class="line">            <span class="operator">??</span> panic(<span class="string">&quot;Could not get Receiver capability&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cap <span class="operator">=</span> <span class="keyword">self</span>.capReceiver.getAllowanceCapsByApprover(from)[<span class="number">0</span>]</span><br><span class="line">        vaultReceiver.deposit(from: <span class="operator">&lt;-</span> cap.borrow()<span class="operator">!</span>.withdraw(amount: value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Alice å¯ä»¥éšæ—¶ä¿®æ”¹ç»™ Bob çš„é¢åº¦ã€‚</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">transaction(spender: <span class="type">Address</span>, value: <span class="type">UFix64</span>) &#123;</span><br><span class="line">    prepare(signer: <span class="type">AuthAccount</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathID <span class="operator">=</span> <span class="string">&quot;fusdAllowanceFor&quot;</span>.concat(spender.toString())</span><br><span class="line">        <span class="keyword">let</span> storagePath <span class="operator">=</span> <span class="type">StoragePath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> allowance <span class="operator">=</span> signer.borrow<span class="operator">&lt;&amp;</span><span class="type">Approver</span>.<span class="type">Allowance</span><span class="operator">&gt;</span>(from: storagePath)</span><br><span class="line">            <span class="operator">??</span> panic(<span class="string">&quot;Could not borrow Allowance reference&quot;</span>)</span><br><span class="line"></span><br><span class="line">        allowance.setAllowance(value: value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Alice ä¹Ÿå¯ä»¥ç»ˆæ­¢ç»™ Bob æˆä¿¡ã€‚</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">transaction(spender: <span class="type">Address</span>) &#123;</span><br><span class="line">    prepare(signer: <span class="type">AuthAccount</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathID <span class="operator">=</span> <span class="string">&quot;fusdAllowanceFor&quot;</span>.concat(spender.toString())</span><br><span class="line">        <span class="keyword">let</span> privatePath <span class="operator">=</span> <span class="type">PrivatePath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line">        <span class="keyword">let</span> publicPath <span class="operator">=</span> <span class="type">PublicPath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">        signer.unlink(privatePath)</span><br><span class="line">        signer.unlink(publicPath)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Alice ä¹Ÿå¯ä»¥æ¢å¤ç»™ Bob çš„æˆä¿¡ã€‚</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">transaction(spender: <span class="type">Address</span>) &#123;</span><br><span class="line">    prepare(signer: <span class="type">AuthAccount</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pathID <span class="operator">=</span> <span class="string">&quot;fusdAllowanceFor&quot;</span>.concat(spender.toString())</span><br><span class="line">        <span class="keyword">let</span> storagePath <span class="operator">=</span> <span class="type">StoragePath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line">        <span class="keyword">let</span> privatePath <span class="operator">=</span> <span class="type">PrivatePath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line">        <span class="keyword">let</span> publicPath <span class="operator">=</span> <span class="type">PublicPath</span>(identifier: pathID)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">        signer.link<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceProvider</span>, <span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(privatePath, target: storagePath)</span><br><span class="line">        signer.link<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(publicPath, target: storagePath)</span><br><span class="line"></span><br><span class="line">        signer.getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceProvider</span>, <span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(privatePath).borrow()</span><br><span class="line">            <span class="operator">??</span> panic(<span class="string">&quot;Could not get private &#123;AllowanceProvider, AllowanceInfo&#125; capability&quot;</span>)</span><br><span class="line">        signer.getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(publicPath).borrow()</span><br><span class="line">            <span class="operator">??</span> panic(<span class="string">&quot;Could not get public &#123;AllowanceInfo&#125; capability&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Alice å¯ä»¥æŸ¥è¯¢è‡ªå·±ç»™æŸäººçš„æˆä¿¡æƒ…å†µã€‚</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">pub <span class="keyword">struct</span> <span class="title class_">AllowanceInfo</span> &#123;</span><br><span class="line">    pub <span class="keyword">let</span> value: <span class="type">UFix64</span></span><br><span class="line">    pub <span class="keyword">let</span> vaultOwner: <span class="type">Address</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">value</span>: <span class="type">UFix64</span>, <span class="params">vaultOwner</span>: <span class="type">Address</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">self</span>.vaultOwner <span class="operator">=</span> vaultOwner</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub fun main(approver: <span class="type">Address</span>, spender: <span class="type">Address</span>): <span class="type">AllowanceInfo</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> path <span class="operator">=</span> <span class="type">PublicPath</span>(identifier: <span class="string">&quot;fusdAllowanceFor&quot;</span>.concat(spender.toString()))<span class="operator">!</span></span><br><span class="line">    <span class="keyword">let</span> info <span class="operator">=</span> getAccount(approver)</span><br><span class="line">        .getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceInfo</span>&#125;<span class="operator">&gt;</span>(path)</span><br><span class="line">        .borrow() <span class="operator">??</span> panic(<span class="string">&quot;Could not borrow AllowanceInfo capability&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="type">AllowanceInfo</span>(value: info.value, vaultOwner: info.getVaultOwner())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Bob ä¹Ÿå¯ä»¥æŸ¥è¯¢ç›®å‰è‡ªå·±æ‰€æœ‰çš„æˆä¿¡æƒ…å†µã€‚</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Approver from &quot;../contracts/Approver.cdc&quot;</span><br><span class="line"></span><br><span class="line">pub <span class="keyword">struct</span> <span class="title class_">AllowanceInfo</span> &#123;</span><br><span class="line">    pub <span class="keyword">let</span> value: <span class="type">UFix64</span></span><br><span class="line">    pub <span class="keyword">let</span> vaultOwner: <span class="type">Address</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">value</span>: <span class="type">UFix64</span>, <span class="params">vaultOwner</span>: <span class="type">Address</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value <span class="operator">=</span> value</span><br><span class="line">        <span class="keyword">self</span>.vaultOwner <span class="operator">=</span> vaultOwner</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pub fun main(approver: <span class="type">Address</span>, spender: <span class="type">Address</span>): [<span class="type">AllowanceInfo</span>] &#123;</span><br><span class="line">    <span class="keyword">let</span> receiver <span class="operator">=</span> getAccount(spender)</span><br><span class="line">        .getCapability<span class="operator">&lt;&amp;</span>&#123;<span class="type">Approver</span>.<span class="type">AllowanceCapReceiverPublic</span>&#125;<span class="operator">&gt;</span>(<span class="type">Approver</span>.<span class="type">AllowanceCapReceiverPubPath</span>)</span><br><span class="line">        .borrow() </span><br><span class="line">        <span class="operator">??</span> panic(<span class="string">&quot;Could not borrow AllowanceCapReceiverPublic capability&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> infos: [<span class="type">AllowanceInfo</span>] <span class="operator">=</span> []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> receiver.getAllowanceCapsInfoByApprover(approver) &#123;</span><br><span class="line">        infos.append(</span><br><span class="line">            <span class="type">AllowanceInfo</span>(value: i.value, vaultOwner: i.getVaultOwner())</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> infos</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œåœ¨ Solidity ä¸­ï¼Œå¦‚æœ Alice åªç»™ Bob æˆä¿¡ï¼Œåˆ™åªæœ‰ Bob å¯ä»¥åŠ¨ç”¨ Alice çš„èµ„äº§ã€‚åœ¨ Cadence ä¸­ï¼ŒBob å®Œå…¨å¯ä»¥æŠŠ Capability è½¬ç§»ç»™ Carlï¼Œè®© Carl ä¹Ÿå¯ä»¥åŠ¨ç”¨ Alice çš„èµ„äº§ï¼ˆå½“ç„¶ï¼Œé¢åº¦æ˜¯ Bob å’Œ Carl å…±äº«çš„ï¼‰ã€‚è¿™æ˜¯ç”±äºŒè€…è®¿é—®æœºåˆ¶çš„å·®å¼‚é€ æˆçš„ã€‚äº‹å®ä¸Šï¼Œå¦‚æœ Bob å’Œ Carl å…±è°‹äº†ï¼Œåˆ™ Bob å°†èµ„äº§è½¬ç§»ç»™ Carl å’Œ Bob ç»™ Carl Capability è®©ä»–è‡ªè¡Œå–ç”¨ä¹Ÿæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<p>Alice å’Œ Bob çš„å­˜å‚¨å¤§æ¦‚æ˜¯è¿™æ ·çš„æƒ…å†µï¼š</p>
<p>è‡³æ­¤æˆ‘ä»¬å®ç°äº†å’Œ ERC20 ä»£å¸æ ‡å‡†ä¸­çš„ approve æœºåˆ¶ç±»ä¼¼çš„åŠŸèƒ½ï¼Œè€Œä¸”åœ¨æ€»é™é¢ä¹‹å¤–è¿˜å¯ä»¥æ–¹ä¾¿åœ°æ·»åŠ æˆæƒè¿‡æœŸæ—¶é—´ã€å•ç¬”æœ€å¤§é™é¢ç­‰æœºåˆ¶ã€‚è™½ç„¶ç›®å‰çœ‹èµ·æ¥æ²¡ä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Œä¸è¿‡â€¦â€¦è¿™ä¸é‡è¦hhhã€‚</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2025/04/05/CaptureTheEther-Math/">â† ä¸‹ä¸€ç¯‡ CaptureTheEther_Math_é¢˜è§£</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/03/15/CaptureTheEther-Lotteries-1-4/">CaptureTheEther_Lotteries_é¢˜è§£ ä¸Šä¸€ç¯‡ â†’</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="å›åˆ°é¡¶éƒ¨" style="opacity: 0; display: none;">âˆ§ </a><a class="i-index" id="to-index" href="#toc-div" title="æ–‡ç« ç›®å½•">â‰¡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="åˆ‡æ¢ä¸»é¢˜"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/1.png" alt="Logo"></a><h1 id="Dr"><a>0xOne1eaF</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>ç›®å½•</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8-Cadence-%E5%AE%9E%E7%8E%B0-ERC20-%E7%9A%84-approve-%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">ç”¨ Cadence å®ç° ERC20 çš„ approve æœºåˆ¶</span></a></li></ol></div></div><footer><nobr>æ„å»ºè‡ª <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> ä½¿ç”¨ä¸»é¢˜ <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> ä¸»é¢˜ä½œè€… <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>